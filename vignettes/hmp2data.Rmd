---
title: "HMP2Data"
author:
- name: John Stansfield
  affiliation:
  - &1 Virginia Commonwealth University, Richmond, VA
- name: Shujian Zhang
  affiliation:
  - &2 The Johns Hopkins University, Baltimore, MD
- name: Ni Zhao
  affiliation:
  - *2
- name: Levi Waldron
  affiliation:
  - &3 Graduate School of Public Health and Health Policy, City University of New York, New York, NY
  - &4 Institute for Implementation Science in Population Health, City University of New York, New York, NY
- name: Ekaterina Smirnova
  affiliation:
  - *1
- name: Mikhail Dozmorov
  affiliation:
  - *1
date: '`r format(Sys.Date(), "%B %e, %Y")`'
abstract: >
    HMP2Data is a Bioconductor package providing the data of the integrative 
    Human Microbiome Project (iHMP), also known as the second phase of HMP 
    project (HMP2). It contains 16S rRNA sequencing data from three longitudinal 
    studies, 1) MOMS-PI, pregnancy and preterm birth; 2) IBD, gut disease onset, 
    inflammatory bowel disease; and 3) T2D, onset of type 2 diabetes and 
    respiratory viral infection. Where available, other data is also provided,
    such as cytokine measures. Raw data files were downloaded from the HMP Data
    Analysis and Coordination Center. Processed data is provided as matrices,
    SummarizedExperiment, MultiAssayExperiment, and phyloseq class objects.
package: HMP2Data
output:
    BiocStyle::html_document
vignette: >
    %\VignetteIndexEntry{HMP2Data}
    %\VignetteEncoding{UTF-8}
    %\VignetteEngine{knitr::rmarkdown}
editor_options:
    chunk_output_type: console
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```


# Prerequisites

`HMP2Data` can be installed using `BiocManager` as follows.

```{r, eval = FALSE}
BiocManager::install("HMP2Data")
```

The following packages will be used in this vignette to provide demonstrative
examples of what a user might do with `r BiocStyle::Biocpkg("HMP2Data")`.

```{r, message=FALSE, warning=FALSE}
library(HMP2Data)
library(phyloseq)
library(SummarizedExperiment)
library(MultiAssayExperiment)
library(dplyr)
```

Once installed, `HMP2Data` provides functions to access the HMP2 data. 

# MOMS-PI

The MOMS-PI data can be loaded as follows.

## 16S data

Load 16S data as a matrix, rows are Greengene IDs, columns are sample names:

```{r}
data("momspi16S_mtx")
momspi16S_mtx[1:5, 1:3]
```

Load the Greengenes taxonomy table as a matrix, rows are Greengene IDs, columns are taxonomic ranks:

```{r}
data("momspi16S_tax")
colnames(momspi16S_tax)
momspi16S_tax[1:5, 1:3]
```

```{r eval=FALSE, echo=FALSE, include=FALSE}
# Check if Greengene IDs match between the 16S and taxonomy data
# all.equal(rownames(momspi16S_mtx), rownames(momspi16S_tax)) # Should be TRUE
```

Load the 16S sample annotation data as a matrix, rows are samples, columns are annotations:

```{r}
data("momspi16S_samp")
colnames(momspi16S_samp)
momspi16S_samp[1:5, 1:5]
```

```{r eval=FALSE, echo=FALSE, include=FALSE}
# Check if sample names match between the 16S and sample data
# all.equal(colnames(momspi16S_mtx), rownames(momspi16S_samp)) # Should be TRUE
```

The `momspi16S` function assembles those matrices into a `phyloseq` object.

```{r, message=FALSE}
momspi16S_phyloseq <- momspi16S()
momspi16S_phyloseq
```

Here we have a `phyloseq` object containing the 16S rRNA seq data for `r nrow(otu_table(momspi16S_phyloseq))` taxa and `r ncol(otu_table(momspi16S_phyloseq))` samples. 

## Cytokine data

The MOMS-PI cytokine data can be loaded as a matrix, rownames are cytokine names, colnames are sample names:

```{r}
data("momspiCyto_mtx")
momspiCyto_mtx[1:5, 1:3]
```

The cytokine data has `r nrow(momspiCyto_mtx)` rows and `r ncol(momspiCyto_mtx)` columns.

Load the cytokine sample annotation data as a matrix, rows are samples, columns are annotations:

```{r}
data("momspiCyto_samp")
colnames(momspiCyto_samp)
momspiCyto_samp[1:5, 1:5]
```

```{r eval=FALSE, echo=FALSE, include=FALSE}
# Check if sample names match between the 16S and sample data
# all.equal(colnames(momspiCyto_mtx), rownames(momspiCyto_samp)) # Should be TRUE
```

The function `momspiCytokines` will make a `SummarizedExperiment` containing cytokine data

```{r}
momspiCyto <- momspiCytokines()
momspiCyto
```

The cytokine data contains data for `r nrow(momspiCyto)` cytokines over `r ncol(momspiCyto)` samples.

## MultiAssayExperiment

We can construct a `MultiAssayExperiment` that will contain 16S and cytokine data for the common samples. Use the `momspiMultiAssay` function.

```{r}
momspiMA <- momspiMultiAssay()
momspiMA
```

### Subsetting the MultiAssayExperiment object

The 16S rRNA data can be extracted from the MultiAssayExperiment object as follows.

```{r}
rRNA <- momspiMA[[1L]]
```

Or, the cytokines data like so.

```{r}
cyto <- momspiMA[[2L]]
```

The sample data can be accessed with the `colData` command.

```{r}
colData(momspiMA) %>% head()
```

To extract only the samples with both 16S and cytokine data we can use the `intersectColumns` function.

```{r}
completeMA <- intersectColumns(momspiMA)
completeMA
```

# IBD

Load 16S data as a matrix, rows are Greengene IDs, columns are sample names:

```{r}
data("IBD16S_mtx")
IBD16S_mtx[1:5, 1:3]
```

Load the Greengenes taxonomy table as a matrix, rows are Greengene IDs, columns are taxonomic ranks:

```{r}
data("IBD16S_tax")
colnames(IBD16S_tax)
IBD16S_tax[1:5, 1:3]
```

Load the 16S sample annotation data as a matrix, rows are samples, columns are annotations:

```{r}
data("IBD16S_samp")
colnames(IBD16S_samp)
IBD16S_samp[1:5, 1:5]
```

The IBD `phyloseq` object can be loaded as follows.

```{r}
IBD <- IBD16S()
IBD
```

# T2D

Load 16S data as a matrix, rows are Greengene IDs, columns are sample names:

```{r}
data("T2D16S_mtx")
T2D16S_mtx[1:5, 1:3]
```

Load the Greengenes taxonomy table as a matrix, rows are Greengene IDs, columns are taxonomic ranks:

```{r}
data("T2D16S_tax")
colnames(T2D16S_tax)
T2D16S_tax[1:5, 1:3]
```

Load the 16S sample annotation data as a matrix, rows are samples, columns are annotations:

```{r}
data("T2D16S_samp")
colnames(T2D16S_samp)
T2D16S_samp[1:5, 1:3]
```

The T2D `phyloseq` object can be loaded like so.

```{r}
T2D <- T2D16S()
T2D
```


# Features

## Frequency Table Generation

The demographic data contianed in `HMP2Data` can be summarized using the `table_two` function. First we need to make a list of the phyloseq and summarized experiment object which can then be entered into the table generating function.


```{r}
list(momspi16S = momspi16S_phyloseq, momspiCytokines = momspiCyto, IBD16S = IBD, T2D16S = T2D) %>% table_two()
```


We can also create a table of the break down of samples by visit number quantile.

```{r}
list(momspi16S = momspi16S_phyloseq, momspiCytokines = momspiCyto, IBD16S = IBD, T2D16S = T2D) %>% visit_table()
```


<!-- The MOMS-PI 16S data contains samples from `r length(unique(sample_data(momspi16S_phyloseq)$sample_body_site))` body sites. The number of samples from each site can be displayed as follows. The subjects were all female and the race was unkown for every participant. -->

<!-- ```{r} -->
<!-- table(sample_data(momspi16S_phyloseq)$sample_body_site, sample_data(momspi16S_phyloseq)$subject_gender)  -->
<!-- ``` -->


<!-- The MOMS-PI cytokine data contains samples from `r length(unique(colData(momspiCyto)$sample_body_site))` body sites. -->

<!-- ```{r} -->
<!-- table(colData(momspiCyto)$sample_body_site, colData(momspiCyto)$subject_gender) -->
<!-- ``` -->

<!-- The IBD data contains samples from feces from males and females and multiple races. -->

<!-- ```{r} -->
<!-- table(sample_data(IBD)$subject_gender, sample_data(IBD)$subject_race) -->
<!-- ``` -->

<!-- The T2D data contains samples from the feces and nasal cavity. -->

<!-- ```{r} -->
<!-- table(sample_data(T2D)$sample_body_site)  -->
<!-- ``` -->

<!-- The demographics of the samples are shown below. -->

<!-- ```{r} -->
<!-- table(sample_data(T2D)$subject_gender, sample_data(T2D)$subject_race) -->
<!-- ``` -->



# Exporting Data to CSV Format

To our knowledge, R and Bioconductor provide the most and best methods for the
analysis of microbiome data. However, we realize they are not the only analysis
environments and wish to provide methods to export the data from
`r BiocStyle::Biocpkg("HMP2Data")` to CSV format. 


## Preparing the data

For `SummarizedExperiment` objects, we will need to separate the data and metadata first before exportation. First, make a `data.frame` for participant data.

```{r}
momspi_cytokines_participants <- colData(momspiCyto)
momspi_cytokines_participants[1:5, 1:3]
```

Then, we need to pull out the data matrix.

```{r}
momspi_cytokines <- assay(momspiCyto)
momspi_cytokines[1:5, 1:3]
```

For `phyloseq` objects the data, metadata, and taxonomy can be separated as follows. First, pull out metadata.

```{r}
momspi_16S_participants <- sample_data(momspi16S_phyloseq)
```

Next, we can save the counts data as a matrix.

```{r}
momspi16s_data <- as.matrix(otu_table(momspi16S_phyloseq))
```

Finally, the taxonomy table can be extracted.

```{r}
momspi16s_taxa <- tax_table(momspi16S_phyloseq) %>% as.data.frame()
```

## Save the data as CSV

The data can be saved as `.csv` files as follows.

```{r, eval = FALSE}
library(readr)
write_csv(data.frame(file_id = rownames(momspi_cytokines_participants), momspi_cytokines_participants), "momspi_cytokines_participants.csv")
write_csv(data.frame(momspi_cytokines), "momspi_cytokines.csv")
```

# Session Info

```{r message=FALSE}
if (!(require(xfun))) install.packages(xfun)
xfun::session_info()
```

